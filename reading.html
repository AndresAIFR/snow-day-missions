<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#FFF8F0">
    <title>Decoder Mission</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>%F0%9F%93%96</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#FFF8F0;--card:#FFFFFF;--border:#2D2D2D;
            --text:#2D2D2D;--text-mid:#555;--text-light:#888;
            --ok:#22C55E;--ok-bg:#DCFCE7;
            --no:#EF4444;--no-bg:#FEE2E2;
            --accent:#3B82F6;--accent-bg:#DBEAFE;
            --bar-bg:#E8E0D6;
        }
        html{font-size:16px}
        body{
            font-family:'DM Sans',system-ui,sans-serif;
            background:var(--bg);color:var(--text);
            min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;
            align-items:center;padding:0 0 60px;
            overflow-x:hidden;-webkit-font-smoothing:antialiased;
            position:relative;
        }

        /* --- SNOWFLAKES --- */
        .snow{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:0}
        .flake{
            position:absolute;top:-20px;color:#B8D4E8;opacity:.6;
            animation:fall linear infinite;
            font-size:var(--size,16px);
        }
        @keyframes fall{
            0%{transform:translateY(-20px) rotate(0deg)}
            100%{transform:translateY(calc(100vh + 40px)) rotate(var(--spin,360deg))}
        }

        /* --- LAYOUT --- */
        .wrap{width:100%;max-width:460px;position:relative;z-index:1;padding:0 16px}

        /* --- TOP BAR --- */
        .top-bar{
            width:100%;background:linear-gradient(180deg,#E8F4FD 0%,var(--bg) 100%);
            padding:14px 16px 0;position:relative;z-index:2;
        }
        .top-bar-inner{max-width:460px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .back-link{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:.9rem;
            color:var(--text-mid);text-decoration:none;display:flex;align-items:center;gap:4px;
            transition:color .15s;
        }
        .back-link:hover{color:var(--text)}
        .back-link svg{width:18px;height:18px}

        /* --- GAME HEADER --- */
        .game-header{
            display:flex;align-items:center;justify-content:space-between;
            padding:16px 0 10px;gap:8px;
        }
        .game-logo{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.1rem;
            letter-spacing:-.3px;white-space:nowrap;
        }
        .header-stats{display:flex;align-items:center;gap:10px}
        .streak-badge{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:1rem;
            display:flex;align-items:center;gap:2px;
        }
        .streak-fire{display:inline-block;transition:transform .2s}
        .streak-fire.pop{animation:firePop .4s ease}
        .points-badge{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:.85rem;
            background:var(--text);color:#fff;padding:4px 12px;border-radius:20px;
            letter-spacing:.3px;
        }

        /* --- LEVEL TABS --- */
        .level-tabs{
            display:flex;gap:6px;padding:8px 0 14px;overflow-x:auto;
            -webkit-overflow-scrolling:touch;scrollbar-width:none;
        }
        .level-tabs::-webkit-scrollbar{display:none}
        .level-tab{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:.72rem;
            padding:5px 11px;border-radius:20px;border:2px solid var(--border);
            background:var(--card);white-space:nowrap;cursor:default;
            transition:all .15s;letter-spacing:.2px;flex-shrink:0;
        }
        .level-tab.current{
            font-weight:700;box-shadow:2px 2px 0 var(--border);
            background:var(--accent-bg);color:var(--accent);border-color:var(--accent);
        }
        .level-tab.done{background:var(--ok-bg);color:var(--ok);border-color:var(--ok)}
        .level-tab.locked{opacity:.4}

        /* --- PROGRESS BAR --- */
        .progress-wrap{padding:0 0 16px}
        .progress-bar{
            height:10px;background:var(--bar-bg);border-radius:8px;
            border:2px solid var(--border);overflow:hidden;
        }
        .progress-fill{
            height:100%;background:var(--ok);border-radius:6px;
            transition:width .4s cubic-bezier(.4,0,.2,1);width:0;
        }

        /* --- CARD --- */
        .card{
            background:var(--card);border:3px solid var(--border);
            border-radius:20px;padding:28px 22px;
            box-shadow:4px 4px 0 var(--border);
            transition:transform .15s;
            position:relative;
        }
        .card.shake{animation:shake .45s ease}
        .card.pop{animation:cardPop .3s ease}

        .card-question{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:1.15rem;
            text-align:center;margin-bottom:20px;line-height:1.4;
        }
        .card-word-display{
            display:flex;justify-content:center;gap:20px;
            margin-bottom:8px;flex-wrap:wrap;
        }
        .card-big-word{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:2.4rem;
            color:var(--accent);letter-spacing:1px;
        }
        .card-vs{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:1rem;
            color:var(--text-light);align-self:center;
        }
        .card-single-word{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:2.8rem;
            text-align:center;color:var(--accent);margin-bottom:8px;letter-spacing:1px;
        }
        .card-part{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:3rem;
            text-align:center;color:var(--accent);margin-bottom:8px;
        }

        /* --- TTS BUTTON --- */
        .tts-btn{
            position:absolute;top:10px;right:10px;
            width:40px;height:40px;border-radius:50%;
            border:2px solid var(--border);background:var(--accent-bg);
            font-size:1.2rem;cursor:pointer;display:flex;
            align-items:center;justify-content:center;
            transition:transform .15s;
            -webkit-tap-highlight-color:transparent;
            z-index:2;
        }
        .tts-btn:hover{transform:scale(1.1)}
        .tts-btn:active{transform:scale(0.95)}

        /* --- LISTEN TO STORY BUTTON --- */
        .listen-story-btn{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:.95rem;
            padding:10px 20px;border-radius:12px;
            border:2px solid var(--accent);background:var(--accent-bg);
            color:var(--accent);cursor:pointer;display:flex;
            align-items:center;justify-content:center;gap:6px;
            margin-bottom:12px;
            -webkit-tap-highlight-color:transparent;
            transition:transform .15s;
        }
        .listen-story-btn:hover{transform:scale(1.02)}
        .listen-story-btn:active{transform:scale(0.97)}

        /* --- ANSWER BUTTONS --- */
        .answers{display:flex;flex-direction:column;gap:10px;margin-top:16px}
        .answers.word-pair{flex-direction:row;gap:12px}
        .answers.word-pair .ans-btn{flex:1}
        .ans-btn{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:1.1rem;
            padding:14px 18px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--card);color:var(--text);
            cursor:pointer;transition:all .1s;
            -webkit-tap-highlight-color:transparent;
            text-align:center;line-height:1.3;
            min-height:48px;
        }
        .ans-btn:active:not(.disabled){
            border-bottom-width:3px;transform:translateY(4px);
        }
        .ans-btn.big-word{font-size:1.5rem;padding:20px 18px}
        .ans-btn.selected-correct{
            background:var(--ok-bg);border-color:var(--ok);color:var(--ok);
        }
        .ans-btn.selected-wrong{
            background:var(--no-bg);border-color:var(--no);color:var(--no);
            animation:shake .45s ease;
        }
        .ans-btn.reveal-correct{
            background:var(--ok-bg);border-color:var(--ok);color:var(--ok);
        }
        .ans-btn.disabled{cursor:default;opacity:.7}
        .ans-btn.pulse{animation:pulse 1.6s ease infinite}

        /* --- FEEDBACK --- */
        .feedback{
            max-height:0;overflow:hidden;
            transition:max-height .35s ease,margin .35s ease,padding .35s ease;
            border-radius:16px;margin-top:0;padding:0 18px;
            font-size:.95rem;line-height:1.5;
        }
        .feedback.show{max-height:200px;margin-top:14px;padding:16px 18px}
        .feedback.correct{background:var(--ok-bg);color:#166534}
        .feedback.wrong{background:var(--no-bg);color:#991B1B}
        .feedback-icon{font-size:1.2rem;margin-right:6px}

        /* --- CONTINUE BUTTON --- */
        .continue-btn{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.15rem;
            width:100%;padding:16px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--ok);color:#fff;cursor:pointer;
            margin-top:16px;display:none;
            -webkit-tap-highlight-color:transparent;
            transition:all .1s;animation:fadeUp .3s ease;
            min-height:48px;
        }
        .continue-btn:active{border-bottom-width:3px;transform:translateY(4px)}
        .continue-btn.visible{display:block}

        /* --- PASSAGE (Level 5) --- */
        .passage-box{
            background:var(--accent-bg);border-left:5px solid var(--accent);
            border-radius:0 12px 12px 0;padding:18px 16px;
            max-height:250px;overflow-y:auto;
            font-size:.95rem;line-height:1.7;margin-bottom:16px;
            -webkit-overflow-scrolling:touch;
        }
        .passage-box p{margin-bottom:12px}
        .passage-box p:last-child{margin-bottom:0}
        .passage-toggle{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:.85rem;
            color:var(--accent);background:none;border:none;cursor:pointer;
            padding:6px 0;margin-bottom:10px;display:flex;align-items:center;gap:4px;
        }
        .passage-toggle svg{width:14px;height:14px;transition:transform .2s}
        .passage-toggle.collapsed svg{transform:rotate(-90deg)}

        /* --- SCREENS --- */
        .screen{display:none;animation:fadeUp .45s ease}
        .screen.active{display:block}

        /* --- INTRO SCREEN --- */
        .intro{text-align:center;padding-top:60px}
        .intro-icon{font-size:4rem;margin-bottom:12px;display:block;animation:bounce .7s cubic-bezier(.34,1.56,.64,1)}
        .intro h1{
            font-family:'Fredoka',sans-serif;font-weight:700;
            font-size:2.2rem;letter-spacing:-1px;margin-bottom:10px;
        }
        .intro p{color:var(--text-mid);font-size:1.05rem;line-height:1.6;margin-bottom:28px;padding:0 10px}
        .intro .start-btn{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.2rem;
            padding:16px 48px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--accent);color:#fff;cursor:pointer;
            -webkit-tap-highlight-color:transparent;
            transition:all .1s;
            min-height:48px;
        }
        .intro .start-btn:active{border-bottom-width:3px;transform:translateY(4px)}

        /* --- RESUME PROMPT --- */
        .resume-prompt{
            margin-top:16px;padding:16px;background:var(--accent-bg);
            border:2px solid var(--accent);border-radius:16px;
            text-align:center;
        }
        .resume-prompt p{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:1rem;
            color:var(--accent);margin-bottom:12px;padding:0;
        }
        .resume-btns{display:flex;gap:10px;justify-content:center}
        .resume-btn{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1rem;
            padding:10px 24px;border-radius:12px;
            border:2px solid var(--border);border-bottom-width:5px;
            cursor:pointer;-webkit-tap-highlight-color:transparent;
            transition:all .1s;min-height:48px;
        }
        .resume-btn:active{border-bottom-width:2px;transform:translateY(3px)}
        .resume-btn.yes{background:var(--ok);color:#fff;border-color:var(--ok)}
        .resume-btn.no{background:var(--card);color:var(--text)}

        /* --- LEVEL COMPLETE SCREEN --- */
        .level-done{text-align:center;padding-top:40px}
        .level-done-icon{font-size:4rem;margin-bottom:12px;display:block}
        .level-done h2{
            font-family:'Fredoka',sans-serif;font-weight:700;
            font-size:1.8rem;letter-spacing:-.5px;margin-bottom:6px;
        }
        .level-done p{color:var(--text-mid);font-size:1rem;margin-bottom:24px}
        .stats-row{display:flex;justify-content:center;gap:16px;margin-bottom:28px;flex-wrap:wrap}
        .stat-box{
            background:var(--card);border:3px solid var(--border);
            border-radius:16px;padding:14px 20px;min-width:90px;
            box-shadow:3px 3px 0 var(--border);
        }
        .stat-box .stat-val{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.6rem;
            color:var(--accent);
        }
        .stat-box .stat-label{font-size:.75rem;color:var(--text-mid);margin-top:2px}
        .next-level-btn{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.15rem;
            padding:16px 48px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--accent);color:#fff;cursor:pointer;
            -webkit-tap-highlight-color:transparent;transition:all .1s;
            min-height:48px;
        }
        .next-level-btn:active{border-bottom-width:3px;transform:translateY(4px)}

        /* --- GAME COMPLETE SCREEN --- */
        .game-done{text-align:center;padding-top:40px}
        .game-done-icon{font-size:4.5rem;margin-bottom:12px;display:block}
        .game-done h2{
            font-family:'Fredoka',sans-serif;font-weight:700;
            font-size:2rem;letter-spacing:-.5px;margin-bottom:6px;
        }
        .game-done p{color:var(--text-mid);font-size:1.05rem;margin-bottom:24px;line-height:1.5}
        .final-btns{display:flex;flex-direction:column;gap:10px;align-items:center}
        .play-again-btn{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.15rem;
            padding:16px 48px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--ok);color:#fff;cursor:pointer;
            -webkit-tap-highlight-color:transparent;transition:all .1s;
            min-height:48px;
        }
        .play-again-btn:active{border-bottom-width:3px;transform:translateY(4px)}
        .back-missions-btn{
            font-family:'Fredoka',sans-serif;font-weight:600;font-size:1rem;
            padding:14px 36px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--card);color:var(--text);cursor:pointer;
            -webkit-tap-highlight-color:transparent;transition:all .1s;
            min-height:48px;
        }
        .back-missions-btn:active{border-bottom-width:3px;transform:translateY(4px)}

        /* --- STORY INTRO --- */
        .story-intro{text-align:center}
        .story-intro h3{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.3rem;
            margin-bottom:6px;
        }
        .story-intro .subtitle{color:var(--text-mid);font-size:.95rem;margin-bottom:18px}
        .story-intro .ready-btn{
            font-family:'Fredoka',sans-serif;font-weight:700;font-size:1.1rem;
            padding:14px 40px;border-radius:16px;
            border:3px solid var(--border);border-bottom-width:7px;
            background:var(--accent);color:#fff;cursor:pointer;
            -webkit-tap-highlight-color:transparent;transition:all .1s;
            margin-top:18px;min-height:48px;
        }
        .story-intro .ready-btn:active{border-bottom-width:3px;transform:translateY(4px)}

        /* --- CONFETTI --- */
        .confetti-piece{
            position:fixed;top:-20px;width:var(--w,10px);height:var(--h,14px);
            background:var(--color,#3B82F6);z-index:100;pointer-events:none;
            border-radius:2px;animation:confettiFall var(--dur,2s) ease-out forwards;
        }
        @keyframes confettiFall{
            0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1}
            80%{opacity:1}
            100%{transform:translateY(calc(100vh + 60px)) rotate(var(--rot,720deg)) scale(.4);opacity:0}
        }

        /* --- ANIMATIONS --- */
        @keyframes bounce{0%{transform:scale(0)}65%{transform:scale(1.15)}100%{transform:scale(1)}}
        @keyframes fadeUp{from{transform:translateY(18px);opacity:0}to{transform:translateY(0);opacity:1}}
        @keyframes shake{
            0%,100%{transform:translateX(0)}
            15%{transform:translateX(-8px)}
            30%{transform:translateX(7px)}
            45%{transform:translateX(-6px)}
            60%{transform:translateX(5px)}
            75%{transform:translateX(-3px)}
        }
        @keyframes cardPop{
            0%{transform:scale(1)}
            50%{transform:scale(1.03)}
            100%{transform:scale(1)}
        }
        @keyframes pulse{
            0%,100%{transform:scale(1)}
            50%{transform:scale(1.015);box-shadow:0 0 0 4px rgba(59,130,246,.15)}
        }
        @keyframes firePop{
            0%{transform:scale(1)}
            40%{transform:scale(1.5)}
            100%{transform:scale(1)}
        }

        /* --- RESPONSIVE: SMALL --- */
        @media(max-width:380px){
            .intro h1{font-size:1.7rem}
            .card-big-word{font-size:1.8rem}
            .card-single-word{font-size:2.2rem}
            .card-part{font-size:2.4rem}
            .ans-btn.big-word{font-size:1.2rem;padding:16px 14px}
            .game-logo{font-size:.95rem}
            .stat-box{padding:10px 14px;min-width:75px}
        }

        /* --- RESPONSIVE: TABLET --- */
        @media(min-width:768px){
            .wrap{max-width:640px}
            .top-bar-inner{max-width:640px}
            .card-question{font-size:1.5rem}
            .card{padding:34px 30px}
            .ans-btn{font-size:1.2rem;padding:18px 22px}
            .ans-btn.big-word{font-size:1.65rem;padding:22px 22px}
            .feedback{font-size:1.05rem}
            .feedback.show{padding:18px 22px}
            .continue-btn{font-size:1.25rem;padding:18px}
            .game-logo{font-size:1.25rem}
            .points-badge{font-size:.95rem;padding:5px 14px}
            .streak-badge{font-size:1.1rem}
            .level-tab{font-size:.8rem;padding:6px 14px}
            .progress-bar{height:12px}
            .intro h1{font-size:2.6rem}
            .intro p{font-size:1.15rem}
            .intro .start-btn{font-size:1.3rem;padding:18px 56px}
            .level-done h2{font-size:2.1rem}
            .game-done h2{font-size:2.3rem}
            .stat-box .stat-val{font-size:1.8rem}
            .next-level-btn{font-size:1.25rem;padding:18px 56px}
            .play-again-btn{font-size:1.25rem;padding:18px 56px}
            .passage-box{font-size:1.05rem;max-height:300px;padding:22px 20px}
            .card-big-word{font-size:2.8rem}
            .card-single-word{font-size:3.2rem}
            .card-part{font-size:3.4rem}
        }

        /* --- RESPONSIVE: DESKTOP --- */
        @media(min-width:1024px){
            .wrap{max-width:720px}
            .top-bar-inner{max-width:720px}
            .card-question{font-size:1.65rem}
            .card{padding:38px 36px}
            .ans-btn{font-size:1.3rem;padding:20px 26px}
            .ans-btn.big-word{font-size:1.8rem;padding:24px 26px}
            .feedback{font-size:1.1rem}
            .feedback.show{padding:20px 26px}
            .continue-btn{font-size:1.35rem;padding:20px}
            .game-logo{font-size:1.35rem}
            .points-badge{font-size:1rem;padding:6px 16px}
            .streak-badge{font-size:1.15rem}
            .level-tab{font-size:.85rem;padding:7px 16px}
            .intro h1{font-size:2.8rem}
            .intro p{font-size:1.2rem}
            .intro .start-btn{font-size:1.4rem;padding:20px 64px}
            .level-done h2{font-size:2.3rem}
            .game-done h2{font-size:2.5rem}
            .stat-box .stat-val{font-size:2rem}
            .next-level-btn{font-size:1.35rem;padding:20px 64px}
            .play-again-btn{font-size:1.35rem;padding:20px 64px}
            .passage-box{font-size:1.1rem;max-height:350px;padding:24px 22px}
            .card-big-word{font-size:3rem}
            .card-single-word{font-size:3.5rem}
            .card-part{font-size:3.6rem}
        }

        /* --- ACCESSIBILITY: REDUCED MOTION --- */
        @media(prefers-reduced-motion:reduce){
            *,*::before,*::after{
                animation-duration:0.01ms !important;
                animation-iteration-count:1 !important;
                transition-duration:0.01ms !important;
            }
            .snow,.flake{display:none !important}
        }
    </style>
</head>
<body>

<div class="snow" id="snow"></div>

<!-- TOP BAR -->
<div class="top-bar">
    <div class="top-bar-inner">
        <a href="index.html" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            Back
        </a>
    </div>
</div>

<div class="wrap">

    <!-- INTRO SCREEN -->
    <div class="screen active" id="screen-intro">
        <div class="intro">
            <span class="intro-icon">&#x1F4D6;</span>
            <h1>Decoder Mission</h1>
            <p>Crack vowel codes, spot sneaky silent e's, smash syllables, and complete a secret story mission!</p>
            <button class="start-btn" onclick="sndClick();startGame()">Let's Go!</button>
            <div id="resume-prompt"></div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div class="screen" id="screen-game">
        <div class="game-header">
            <div class="game-logo">&#x1F4D6; Decoder Mission</div>
            <div class="header-stats">
                <div class="streak-badge"><span class="streak-fire" id="streak-fire">&#x1F525;</span><span id="streak-num">0</span></div>
                <div class="points-badge" id="points-badge">0 pts</div>
            </div>
        </div>

        <div class="level-tabs" id="level-tabs"></div>

        <div class="progress-wrap">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <!-- Story passage (level 5 only) -->
        <div id="passage-area" style="display:none"></div>

        <div class="card" id="question-card"></div>

        <div class="answers" id="answers-area"></div>

        <div class="feedback" id="feedback"></div>

        <button class="continue-btn" id="continue-btn" onclick="sndClick();nextQuestion()">Next</button>
    </div>

    <!-- LEVEL COMPLETE SCREEN -->
    <div class="screen" id="screen-level-done">
        <div class="level-done" id="level-done-content"></div>
    </div>

    <!-- GAME COMPLETE SCREEN -->
    <div class="screen" id="screen-game-done">
        <div class="game-done" id="game-done-content"></div>
    </div>

    <!-- STORY INTRO SCREEN (Level 5 passage reading) -->
    <div class="screen" id="screen-story-intro">
        <div class="story-intro" id="story-intro-content"></div>
    </div>

</div>

<script>
/* --- SNOWFLAKES --- */
(function(){
    var c = document.getElementById('snow');
    var f = ['\u2744','\u2745','\u2746','\u2022'];
    for(var i = 0; i < 30; i++){
        var el = document.createElement('div');
        el.className = 'flake';
        el.textContent = f[Math.random()*f.length|0];
        var size = 10 + Math.random()*18;
        var dur = 6 + Math.random()*10;
        var delay = Math.random()*8;
        var left = Math.random()*100;
        var spin = 180 + Math.random()*540;
        el.style.cssText =
            'left:'+left+'%;--size:'+size+'px;font-size:'+size+'px;'+
            'animation-duration:'+dur+'s;animation-delay:'+delay+'s;'+
            '--spin:'+spin+'deg;opacity:'+(0.2+Math.random()*0.4)+';';
        c.appendChild(el);
    }
})();

/* --- SOUND EFFECTS (Web Audio API) --- */
var AudioCtx = window.AudioContext || window.webkitAudioContext;
var _actx;
function actx(){ if(!_actx) _actx = new AudioCtx(); return _actx; }

function sndCorrect(){
    var c=actx(), t=c.currentTime;
    [523.25,659.25].forEach(function(f,i){
        var o=c.createOscillator(),g=c.createGain();
        o.connect(g);g.connect(c.destination);
        o.frequency.value=f;
        g.gain.setValueAtTime(0.25,t+i*0.12);
        g.gain.exponentialRampToValueAtTime(0.001,t+i*0.12+0.3);
        o.start(t+i*0.12);o.stop(t+i*0.12+0.3);
    });
}

function sndWrong(){
    var c=actx(),t=c.currentTime,o=c.createOscillator(),g=c.createGain();
    o.type='triangle';o.connect(g);g.connect(c.destination);
    o.frequency.setValueAtTime(200,t);o.frequency.linearRampToValueAtTime(140,t+0.25);
    g.gain.setValueAtTime(0.18,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
    o.start(t);o.stop(t+0.3);
}

function sndLevelUp(){
    var c=actx(),t=c.currentTime;
    [523.25,659.25,783.99].forEach(function(f,i){
        var o=c.createOscillator(),g=c.createGain();
        o.connect(g);g.connect(c.destination);
        o.frequency.value=f;
        g.gain.setValueAtTime(0.25,t+i*0.15);
        g.gain.exponentialRampToValueAtTime(0.001,t+i*0.15+0.45);
        o.start(t+i*0.15);o.stop(t+i*0.15+0.45);
    });
}

function sndClick(){
    var c=actx(),t=c.currentTime,o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);
    o.frequency.value=880;
    g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.06);
    o.start(t);o.stop(t+0.06);
}

/* --- TEXT-TO-SPEECH --- */
function speak(text){
    if(!('speechSynthesis' in window)) return;
    speechSynthesis.cancel();
    var u = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g,''));
    u.rate = 0.85;
    u.pitch = 1.1;
    speechSynthesis.speak(u);
}

/* --- QUESTION DATA --- */
var PASSAGE = "Today was supposed to be a normal day, but the snow came down fast. By lunch, the sidewalks were covered and the buses were late. Jaylen looked out the window and saw something weird. A small remote drone hovered near the playground and blinked a blue light.\n\nA note dropped from the drone and landed on the steps. Jaylen picked it up. The message said: \u201CComplete the mission. Protect the supplies.\u201D\n\nJaylen did not love surprises, but he liked a challenge. He went to the storage room and saw a stack of boxes labeled \u201CART CLUB.\u201D The tape was loose, and the boxes looked wobbly. If they fell, paint could spill everywhere.\n\nJaylen made a plan. First, he asked a friend to pre-check the room for anything unsafe. Next, Jaylen used extra tape to re-seal each box. Then he stacked the boxes again, with the heavy ones on the bottom.\n\nWhen he finished, the drone blinked green. Another note dropped: \u201CMission success. You were helpful and fearless.\u201D Jaylen laughed. Maybe snow days were not only about staying home. Sometimes, they were about being ready.";

var LEVELS = [
    {
        name:"Vowel Spy", subtitle:"Find the long vowels!", type:"vowel",
        qs:[
            {words:["tap","tape"], ans:"tape", tip:"'tape' has a VCe pattern \u2014 the silent e makes the 'a' say its name!"},
            {words:["kit","kite"], ans:"kite", tip:"The silent e in 'kite' makes the 'i' long \u2014 like flying a kite!"},
            {words:["hop","hope"], ans:"hope", tip:"'hope' has a silent e that makes the 'o' say its name!"},
            {words:["mad","made"], ans:"made", tip:"The e in 'made' changes the short 'a' to a long 'a' sound!"},
            {words:["pin","pine"], ans:"pine", tip:"'pine' has VCe \u2014 the silent e turns the short 'i' into a long 'i'!"},
            {words:["rob","robe"], ans:"robe", tip:"'robe' \u2014 the e at the end makes the 'o' say its name!"},
            {words:["cut","cute"], ans:"cute", tip:"'cute' has VCe \u2014 the silent e makes it say 'kyoot' not 'kuht'!"},
            {words:["plan","plane"], ans:"plane", tip:"The e changes 'plan' to 'plane' \u2014 short vowel becomes long!"}
        ]
    },
    {
        name:"Silent e Detective", subtitle:"Spot the sneaky silent e!", type:"silente",
        qs:[
            {word:"complete", ans:"yes", tip:"Yes! 'complete' ends with a silent e. com-PLETE!"},
            {word:"invite", ans:"yes", tip:"Yes! 'invite' has a silent e at the end. in-VITE!"},
            {word:"basket", ans:"no", tip:"No silent e here! 'basket' ends with a 't' sound. BAS-ket!"},
            {word:"dislike", ans:"yes", tip:"Yes! 'dislike' ends with a silent e. dis-LIKE!"},
            {word:"athlete", ans:"yes", tip:"Yes! 'athlete' has a silent e at the end. ATH-lete!"}
        ]
    },
    {
        name:"Syllable Smash", subtitle:"Break words apart!", type:"syllable",
        qs:[
            {word:"fantastic", opts:["fan / tas / tic","fant / as / tic","fan / tast / ic"], ans:0, tip:"fan-tas-tic! 3 syllables \u2014 clap it out!"},
            {word:"sunshine", opts:["sun / shine","su / nshine","suns / hine"], ans:0, tip:"sun-shine! 2 syllables \u2014 it\u2019s a compound word!"},
            {word:"confuse", opts:["con / fuse","conf / use","co / nfuse"], ans:0, tip:"con-fuse! 2 syllables. The 'fuse' part has a VCe pattern!"},
            {word:"mistake", opts:["mis / take","mist / ake","mi / stake"], ans:0, tip:"mis-take! 2 syllables. 'take' has a VCe pattern!"},
            {word:"protect", opts:["pro / tect","prot / ect","pr / otect"], ans:0, tip:"pro-tect! 2 syllables. Both are closed syllables!"},
            {word:"remote", opts:["re / mote","rem / ote","remo / te"], ans:0, tip:"re-mote! 2 syllables. 'mote' is a VCe pattern!"}
        ]
    },
    {
        name:"Word Part Power", subtitle:"Learn the meaning of word parts!", type:"wordpart",
        qs:[
            {part:"re-", opts:["again","before","without"], ans:0, tip:"re- means 'again'! Like re-do = do again!"},
            {part:"un-", opts:["full of","not / opposite","again"], ans:1, tip:"un- means 'not' or 'opposite'! Like un-happy = not happy!"},
            {part:"pre-", opts:["without","again","before"], ans:2, tip:"pre- means 'before'! Like pre-heat = heat before!"},
            {part:"-ful", opts:["full of","without","the result of"], ans:0, tip:"-ful means 'full of'! Like hope-ful = full of hope!"},
            {part:"-less", opts:["again","without","full of"], ans:1, tip:"-less means 'without'! Like hope-less = without hope!"},
            {part:"-ment", opts:["before","without","the result or act of"], ans:2, tip:"-ment means 'the result or act of'! Like enjoy-ment = the act of enjoying!"}
        ]
    },
    {
        name:"Story Mission", subtitle:"Read and answer!", type:"story",
        qs:[
            {q:"What problem do the boxes create?", opts:["They are too heavy to move","They could fall and spill paint everywhere","They are blocking the door"], ans:1, tip:"The passage says 'the boxes looked wobbly. If they fell, paint could spill everywhere.'"},
            {q:"What does Jaylen do FIRST to fix the problem?", opts:["He stacks the boxes again","He asks a friend to check the room","He uses tape to seal boxes"], ans:1, tip:"The passage says 'First, he asked a friend to pre-check the room for anything unsafe.'"},
            {q:"The drone makes the story feel like what genre?", opts:["Realistic fiction","Mystery / Sci-fi action","Historical fiction"], ans:1, tip:"A drone delivering secret mission notes is like something from a spy or sci-fi movie!"},
            {q:"Which word from the story has a PREFIX?", opts:["stacked","re-seal","heavy"], ans:1, tip:"'re-seal' has the prefix 're-' which means 'again' \u2014 Jaylen sealed the boxes again!"},
            {q:"What is the MAIN idea of the story?", opts:["Snow days are boring","Drones are dangerous","Being ready to help is important"], ans:2, tip:"The story ends with 'Sometimes, they were about being ready.' That\u2019s the main message!"}
        ]
    }
];

var LEVEL_COMPLETE_MSG = [
    {t:"Vowel Spy Complete!",d:"You found all the long vowels!",icon:"\uD83D\uDD0D"},
    {t:"Silent e Spotted!",d:"Nothing gets past you!",icon:"\uD83D\uDD75\uFE0F"},
    {t:"Syllables Smashed!",d:"You broke those words apart like a pro!",icon:"\uD83D\uDCAA"},
    {t:"Word Parts Mastered!",d:"Prefixes and suffixes can\u2019t fool you!",icon:"\u2B50"},
    {t:"Story Mission Complete!",d:"You read, understood, and conquered!",icon:"\uD83C\uDF1F"}
];

/* --- GAME STATE --- */
var state = {
    level: 0,
    qi: 0,
    points: 0,
    streak: 0,
    bestStreak: 0,
    totalCorrect: 0,
    totalQuestions: 0,
    levelCorrect: 0,
    levelPoints: 0,
    answered: false,
    passageVisible: true
};

var advancing = false;

/* --- HELPERS --- */
function $(id){ return document.getElementById(id); }

function showScreen(id){
    var screens = document.querySelectorAll('.screen');
    for(var i=0;i<screens.length;i++) screens[i].classList.remove('active');
    $(id).classList.add('active');
}

function shuffle(arr){
    var a = arr.slice();
    for(var i=a.length-1;i>0;i--){
        var j = Math.random()*(i+1)|0;
        var t=a[i];a[i]=a[j];a[j]=t;
    }
    return a;
}

/* --- ANIMATED POINTS COUNTER --- */
function animatePoints(from, to){
    var el = $('points-badge');
    if(!el) return;
    if(from >= to){ el.textContent = to + ' pts'; return; }
    var current = from;
    var step = function(){
        current += 1;
        if(current > to) current = to;
        el.textContent = current + ' pts';
        if(current < to) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
}

function updateHeader(){
    $('streak-num').textContent = state.streak;
    /* points-badge is updated via animatePoints in handleAnswer */
}

function buildLevelTabs(){
    var tabs = $('level-tabs');
    tabs.innerHTML = '';
    for(var i=0;i<LEVELS.length;i++){
        var tab = document.createElement('div');
        tab.className = 'level-tab';
        if(i < state.level) tab.classList.add('done');
        else if(i === state.level) tab.classList.add('current');
        else tab.classList.add('locked');
        tab.textContent = LEVELS[i].name;
        tabs.appendChild(tab);
    }
    /* scroll current tab into view */
    var cur = tabs.querySelector('.current');
    if(cur) cur.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
}

function updateProgress(){
    var level = LEVELS[state.level];
    var pct = level ? (state.qi / level.qs.length * 100) : 100;
    $('progress-fill').style.width = pct + '%';
}

/* --- LOCALSTORAGE PROGRESS --- */
function saveProgress(){
    localStorage.setItem('reading-progress', JSON.stringify({
        li: state.level, qi: state.qi, score: state.points,
        streak: state.streak, best: state.bestStreak,
        totalHit: state.totalCorrect, totalQ: state.totalQuestions,
        lvlHit: state.levelCorrect, lvlPts: state.levelPoints,
        passVis: state.passageVisible
    }));
}

function loadProgress(){
    var d = localStorage.getItem('reading-progress');
    if(d){
        try { return JSON.parse(d); } catch(e){ return null; }
    }
    return null;
}

function clearProgress(){
    localStorage.removeItem('reading-progress');
}

/* --- CONFETTI --- */
function spawnConfetti(){
    var colors = ['#3B82F6','#22C55E','#EF4444','#F59E0B','#8B5CF6','#EC4899','#14B8A6'];
    for(var i=0;i<55;i++){
        var piece = document.createElement('div');
        piece.className = 'confetti-piece';
        var w = 6+Math.random()*10;
        var h = 8+Math.random()*14;
        var dur = (1.4+Math.random()*1.2).toFixed(2);
        var rot = 360+Math.random()*720;
        piece.style.cssText =
            'left:'+Math.random()*100+'%;'+
            '--w:'+w+'px;--h:'+h+'px;'+
            '--color:'+colors[Math.random()*colors.length|0]+';'+
            '--dur:'+dur+'s;--rot:'+rot+'deg;'+
            'animation-delay:'+(Math.random()*0.4).toFixed(2)+'s;';
        document.body.appendChild(piece);
        (function(el,d){
            setTimeout(function(){ if(el.parentNode) el.parentNode.removeChild(el); }, parseFloat(d)*1000+600);
        })(piece, dur);
    }
}

/* --- FIRE POP --- */
function popFire(){
    var f = $('streak-fire');
    f.classList.remove('pop');
    void f.offsetWidth;
    f.classList.add('pop');
}

/* --- GET QUESTION TEXT FOR TTS --- */
function getQuestionText(){
    var level = LEVELS[state.level];
    var q = level.qs[state.qi];
    if(level.type === 'vowel'){
        return 'Which word has the long vowel sound? ' + q.words[0] + ' or ' + q.words[1];
    } else if(level.type === 'silente'){
        return 'Does this word end with a silent e? ' + q.word;
    } else if(level.type === 'syllable'){
        return 'How do you split this word into syllables? ' + q.word;
    } else if(level.type === 'wordpart'){
        return 'What does this word part mean? ' + q.part;
    } else if(level.type === 'story'){
        return q.q;
    }
    return '';
}

/* --- RENDER QUESTION --- */
function renderQuestion(){
    var level = LEVELS[state.level];
    var q = level.qs[state.qi];
    var card = $('question-card');
    var answers = $('answers-area');
    var fb = $('feedback');
    var cont = $('continue-btn');
    var passageArea = $('passage-area');

    state.answered = false;
    advancing = false;
    fb.className = 'feedback';
    fb.innerHTML = '';
    cont.classList.remove('visible');
    card.className = 'card';
    answers.className = 'answers';
    answers.innerHTML = '';

    /* TTS button HTML */
    var ttsBtn = '<button class="tts-btn" onclick="event.stopPropagation();sndClick();speak(getQuestionText())" aria-label="Read question aloud">\uD83D\uDD0A</button>';

    /* passage area */
    if(level.type === 'story' && state.passageVisible){
        passageArea.style.display = 'block';
        passageArea.innerHTML =
            '<button class="listen-story-btn" onclick="sndClick();speak(PASSAGE)">' +
                '\uD83D\uDD0A Listen to Story' +
            '</button>' +
            '<button class="passage-toggle" onclick="togglePassage()">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>' +
                ' Story: Operation Snow Rescue' +
            '</button>' +
            '<div class="passage-box" id="passage-content">' +
                PASSAGE.split('\n\n').map(function(p){return '<p>'+p+'</p>';}).join('') +
            '</div>';
    } else if(level.type !== 'story'){
        passageArea.style.display = 'none';
    }

    /* determine last question of entire game */
    var isLastQ = (state.level === LEVELS.length-1) && (state.qi === level.qs.length-1);

    /* LEVEL 1: Vowel Spy */
    if(level.type === 'vowel'){
        var shuffled = shuffle(q.words);
        card.innerHTML = ttsBtn +
            '<div class="card-question">Which word has the <strong>LONG</strong> vowel sound?</div>' +
            '<div class="card-word-display">' +
                '<span class="card-big-word">'+shuffled[0]+'</span>' +
                '<span class="card-vs">vs</span>' +
                '<span class="card-big-word">'+shuffled[1]+'</span>' +
            '</div>';
        answers.classList.add('word-pair');
        shuffled.forEach(function(w){
            var btn = document.createElement('button');
            btn.className = 'ans-btn big-word pulse';
            btn.textContent = w;
            btn.onclick = function(){ sndClick(); handleAnswer(w === q.ans, btn, q.tip); };
            answers.appendChild(btn);
        });
    }
    /* LEVEL 2: Silent e */
    else if(level.type === 'silente'){
        card.innerHTML = ttsBtn +
            '<div class="card-question">Does this word end with a <strong>silent e</strong>?</div>' +
            '<div class="card-single-word">'+q.word+'</div>';
        answers.classList.add('word-pair');
        ['Yes!','No!'].forEach(function(label){
            var val = label === 'Yes!' ? 'yes' : 'no';
            var btn = document.createElement('button');
            btn.className = 'ans-btn big-word pulse';
            btn.textContent = label;
            btn.onclick = function(){ sndClick(); handleAnswer(val === q.ans, btn, q.tip); };
            answers.appendChild(btn);
        });
    }
    /* LEVEL 3: Syllable */
    else if(level.type === 'syllable'){
        card.innerHTML = ttsBtn +
            '<div class="card-question">How do you split this word into syllables?</div>' +
            '<div class="card-single-word">'+q.word+'</div>';
        q.opts.forEach(function(opt,i){
            var btn = document.createElement('button');
            btn.className = 'ans-btn pulse';
            btn.textContent = opt;
            btn.onclick = function(){ sndClick(); handleAnswer(i === q.ans, btn, q.tip); };
            answers.appendChild(btn);
        });
    }
    /* LEVEL 4: Word Part */
    else if(level.type === 'wordpart'){
        card.innerHTML = ttsBtn +
            '<div class="card-question">What does this word part mean?</div>' +
            '<div class="card-part">'+q.part+'</div>';
        q.opts.forEach(function(opt,i){
            var btn = document.createElement('button');
            btn.className = 'ans-btn pulse';
            btn.textContent = opt;
            btn.onclick = function(){ sndClick(); handleAnswer(i === q.ans, btn, q.tip); };
            answers.appendChild(btn);
        });
    }
    /* LEVEL 5: Story */
    else if(level.type === 'story'){
        card.innerHTML = ttsBtn +
            '<div class="card-question">'+q.q+'</div>';
        q.opts.forEach(function(opt,i){
            var btn = document.createElement('button');
            btn.className = 'ans-btn pulse';
            btn.textContent = opt;
            btn.onclick = function(){ sndClick(); handleAnswer(i === q.ans, btn, q.tip); };
            answers.appendChild(btn);
        });
    }

    /* set continue button text */
    cont.textContent = isLastQ ? 'See Results' : 'Next';

    updateProgress();
}

/* --- TOGGLE PASSAGE --- */
function togglePassage(){
    var content = document.getElementById('passage-content');
    var toggle = document.querySelector('.passage-toggle');
    if(!content) return;
    if(content.style.display === 'none'){
        content.style.display = 'block';
        toggle.classList.remove('collapsed');
    } else {
        content.style.display = 'none';
        toggle.classList.add('collapsed');
    }
}

/* --- HANDLE ANSWER --- */
function handleAnswer(correct, btn, tip){
    if(state.answered) return;
    state.answered = true;
    state.totalQuestions++;

    var card = $('question-card');
    var fb = $('feedback');
    var cont = $('continue-btn');
    var allBtns = document.querySelectorAll('.ans-btn');
    var oldPoints = state.points;

    /* disable all buttons */
    for(var i=0;i<allBtns.length;i++){
        allBtns[i].classList.add('disabled');
        allBtns[i].classList.remove('pulse');
    }

    var feedbackText = '';

    if(correct){
        sndCorrect();
        state.totalCorrect++;
        state.levelCorrect++;
        state.streak++;
        if(state.streak > state.bestStreak) state.bestStreak = state.streak;
        state.points += 10;
        state.levelPoints += 10;
        if(state.streak >= 3){
            state.points += 5;
            state.levelPoints += 5;
            popFire();
        }
        btn.classList.add('selected-correct');
        card.classList.add('pop');
        feedbackText = (state.streak >= 3 ? '+15 pts! Streak bonus! ' : '+10 pts! ') + tip;
        fb.className = 'feedback correct show';
        fb.innerHTML = '<span class="feedback-icon">\u2705</span> ' +
            (state.streak >= 3 ? '<strong>+15 pts! Streak bonus!</strong> ' : '<strong>+10 pts!</strong> ') +
            tip;
    } else {
        sndWrong();
        state.streak = 0;
        btn.classList.add('selected-wrong');
        card.classList.add('shake');
        feedbackText = 'Not quite! ' + tip;
        fb.className = 'feedback wrong show';
        fb.innerHTML = '<span class="feedback-icon">\uD83D\uDCA1</span> <strong>Not quite!</strong> ' + tip;

        /* reveal correct answer */
        var level = LEVELS[state.level];
        var q = level.qs[state.qi];
        if(level.type === 'vowel'){
            for(var j=0;j<allBtns.length;j++){
                if(allBtns[j].textContent === q.ans) allBtns[j].classList.add('reveal-correct');
            }
        } else if(level.type === 'silente'){
            var correctLabel = q.ans === 'yes' ? 'Yes!' : 'No!';
            for(var j=0;j<allBtns.length;j++){
                if(allBtns[j].textContent === correctLabel) allBtns[j].classList.add('reveal-correct');
            }
        } else {
            allBtns[q.ans].classList.add('reveal-correct');
        }
    }

    /* Animate points counter */
    animatePoints(oldPoints, state.points);
    $('streak-num').textContent = state.streak;

    cont.classList.add('visible');

    /* Auto-read feedback aloud */
    setTimeout(function(){ speak(feedbackText); }, 400);

    /* Save progress after each answer */
    saveProgress();
}

/* --- NEXT QUESTION --- */
function nextQuestion(){
    if(advancing) return;
    advancing = true;

    speechSynthesis.cancel();

    var level = LEVELS[state.level];
    state.qi++;

    if(state.qi >= level.qs.length){
        /* level complete */
        if(state.level >= LEVELS.length - 1){
            showGameComplete();
        } else {
            showLevelComplete();
        }
        return;
    }

    saveProgress();
    renderQuestion();
}

/* --- LEVEL COMPLETE --- */
function showLevelComplete(){
    sndLevelUp();
    var msg = LEVEL_COMPLETE_MSG[state.level];
    var content = $('level-done-content');
    content.innerHTML =
        '<span class="level-done-icon">' + msg.icon + '</span>' +
        '<h2>' + msg.t + '</h2>' +
        '<p>' + msg.d + '</p>' +
        '<div class="stats-row">' +
            '<div class="stat-box"><div class="stat-val">'+state.levelPoints+'</div><div class="stat-label">Points</div></div>' +
            '<div class="stat-box"><div class="stat-val">'+state.levelCorrect+'/'+LEVELS[state.level].qs.length+'</div><div class="stat-label">Correct</div></div>' +
            '<div class="stat-box"><div class="stat-val">'+state.bestStreak+'</div><div class="stat-label">Best Streak</div></div>' +
        '</div>' +
        '<button class="next-level-btn" onclick="sndClick();goNextLevel()">Next Level</button>';

    showScreen('screen-level-done');
    spawnConfetti();
    advancing = false;
    saveProgress();
}

/* --- GAME COMPLETE --- */
function showGameComplete(){
    sndLevelUp();
    var content = $('game-done-content');
    content.innerHTML =
        '<span class="game-done-icon">\uD83C\uDFC6</span>' +
        '<h2>Mission Complete!</h2>' +
        '<p>You cracked every code and finished the story!<br>Amazing work, decoder!</p>' +
        '<div class="stats-row">' +
            '<div class="stat-box"><div class="stat-val">'+state.points+'</div><div class="stat-label">Total Points</div></div>' +
            '<div class="stat-box"><div class="stat-val">'+state.totalCorrect+'/'+state.totalQuestions+'</div><div class="stat-label">Correct</div></div>' +
            '<div class="stat-box"><div class="stat-val">'+state.bestStreak+'</div><div class="stat-label">Best Streak</div></div>' +
        '</div>' +
        '<div class="final-btns">' +
            '<button class="play-again-btn" onclick="sndClick();resetGame()">Play Again</button>' +
            '<a href="index.html"><button class="back-missions-btn" onclick="sndClick()">Back to Missions</button></a>' +
        '</div>';

    showScreen('screen-game-done');
    spawnConfetti();
    advancing = false;
    clearProgress();
}

/* --- GO NEXT LEVEL --- */
function goNextLevel(){
    state.level++;
    state.qi = 0;
    state.levelCorrect = 0;
    state.levelPoints = 0;

    buildLevelTabs();
    saveProgress();

    /* Level 5 = story: show passage first */
    if(LEVELS[state.level].type === 'story'){
        showStoryIntro();
        return;
    }

    showScreen('screen-game');
    renderQuestion();
}

/* --- STORY INTRO --- */
function showStoryIntro(){
    var content = $('story-intro-content');
    content.innerHTML =
        '<h3>\uD83D\uDCDC Operation Snow Rescue</h3>' +
        '<p class="subtitle">Read the passage carefully, then answer questions about it.</p>' +
        '<button class="listen-story-btn" onclick="sndClick();speak(PASSAGE)" style="margin:0 auto 12px">' +
            '\uD83D\uDD0A Listen to Story' +
        '</button>' +
        '<div class="passage-box" style="max-height:350px;text-align:left">' +
            PASSAGE.split('\n\n').map(function(p){return '<p>'+p+'</p>';}).join('') +
        '</div>' +
        '<button class="ready-btn" onclick="sndClick();startStoryQuestions()">I\'m Ready!</button>';
    showScreen('screen-story-intro');
}

function startStoryQuestions(){
    state.passageVisible = true;
    showScreen('screen-game');
    renderQuestion();
}

/* --- START GAME --- */
function startGame(){
    state.level = 0;
    state.qi = 0;
    state.points = 0;
    state.streak = 0;
    state.bestStreak = 0;
    state.totalCorrect = 0;
    state.totalQuestions = 0;
    state.levelCorrect = 0;
    state.levelPoints = 0;

    clearProgress();
    buildLevelTabs();
    updateHeader();
    $('points-badge').textContent = '0 pts';
    showScreen('screen-game');
    renderQuestion();
}

/* --- RESUME GAME FROM SAVED PROGRESS --- */
function resumeGame(saved){
    state.level = saved.li || 0;
    state.qi = saved.qi || 0;
    state.points = saved.score || 0;
    state.streak = saved.streak || 0;
    state.bestStreak = saved.best || 0;
    state.totalCorrect = saved.totalHit || 0;
    state.totalQuestions = saved.totalQ || 0;
    state.levelCorrect = saved.lvlHit || 0;
    state.levelPoints = saved.lvlPts || 0;
    state.passageVisible = saved.passVis !== false;

    buildLevelTabs();
    $('streak-num').textContent = state.streak;
    $('points-badge').textContent = state.points + ' pts';

    if(LEVELS[state.level] && LEVELS[state.level].type === 'story' && state.qi === 0){
        showStoryIntro();
    } else {
        showScreen('screen-game');
        renderQuestion();
    }
}

/* --- RESET GAME --- */
function resetGame(){
    clearProgress();
    showScreen('screen-intro');
    $('resume-prompt').innerHTML = '';
}

/* --- CHECK FOR SAVED PROGRESS ON LOAD --- */
(function(){
    var saved = loadProgress();
    if(saved && saved.li != null && (saved.li > 0 || saved.qi > 0)){
        var levelName = LEVELS[saved.li] ? LEVELS[saved.li].name : 'Level ' + (saved.li+1);
        var prompt = $('resume-prompt');
        prompt.innerHTML =
            '<div class="resume-prompt">' +
                '<p>Continue where you left off?<br>' + levelName + ' \u2014 ' + (saved.score||0) + ' pts</p>' +
                '<div class="resume-btns">' +
                    '<button class="resume-btn yes" onclick="sndClick();resumeGame(' + JSON.stringify(saved).replace(/"/g,'&quot;') + ')">Continue</button>' +
                    '<button class="resume-btn no" onclick="sndClick();clearProgress();this.parentNode.parentNode.parentNode.innerHTML=\'\'">Start Over</button>' +
                '</div>' +
            '</div>';
    }
})();
</script>
</body>
</html>
